# å·¥å‚æ–¹å¼ä¾èµ–æ³¨å…¥å®Œæ•´æŒ‡å—

## é—®é¢˜æ’æŸ¥

æ‚¨é‡åˆ°çš„é”™è¯¯ï¼š
```
[UIShopPanelDI] æ— æ³•è§£æ IShopServiceï¼Œè¯·æ£€æŸ¥ Bootstrapper é…ç½®
```

**åŸå› **ï¼šShopService æ²¡æœ‰åœ¨ Bootstrapper ä¸­æ³¨å†Œ

---

## âœ… è§£å†³æ–¹æ¡ˆï¼šåœ¨ Bootstrapper ä¸­æ³¨å†ŒæœåŠ¡

### ä¿®æ”¹ Bootstrapper.cs

åœ¨ `RegisterFrameworkServices()` æ–¹æ³•ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```csharp
private void RegisterFrameworkServices(IContainerBuilder builder)
{
    // ... å…¶ä»–æ¡†æ¶æœåŠ¡ ...
    
    // æ³¨å†Œäº‹ä»¶æ€»çº¿
    builder.Register<EventBus>(Lifetime.Singleton).As<IEventBus>();
    
    // æ³¨å†Œä»»åŠ¡è°ƒåº¦å™¨
    builder.Register<TaskScheduler>(Lifetime.Singleton).As<ITaskScheduler>();
    
    // æ³¨å†Œæ—¶é—´æœåŠ¡
    builder.Register<TimeService>(Lifetime.Singleton).As<ITimeService>();
    
    // âœ… æ·»åŠ è¿™ä¸€è¡Œï¼šæ³¨å†Œå•†åº—æœåŠ¡
    builder.Register<ShopService>(Lifetime.Singleton).As<IShopService>();
    
    // ... å…¶ä»–æœåŠ¡ ...
}
```

**å…³é”®ç‚¹**ï¼š
- `ShopService` æ˜¯å®ç°ç±»
- `IShopService` æ˜¯æ¥å£
- `Lifetime.Singleton` è¡¨ç¤ºå…¨å±€å•ä¾‹
- è¿™æ · `Bootstrapper.Resolve<IShopService>()` å°±èƒ½æ‰¾åˆ°å®ä¾‹

---

## ğŸ“‹ å®Œæ•´çš„å·¥å‚æ¨¡å¼ä½¿ç”¨æµç¨‹

### ç¬¬ä¸€æ­¥ï¼šæ³¨å†Œæ‰€æœ‰æœåŠ¡ï¼ˆBootstrapperï¼‰

```csharp
public class Bootstrapper : LifetimeScope
{
    protected override void Configure(IContainerBuilder builder)
    {
        base.Configure(builder);
        RegisterFrameworkServices(builder);
        RegisterManualServices(builder);
        InvokeServiceRegistrars(builder);
    }

    private void RegisterFrameworkServices(IContainerBuilder builder)
    {
        // æ¡†æ¶æœåŠ¡
        builder.Register<EventBus>(Lifetime.Singleton).As<IEventBus>();
        builder.Register<TaskScheduler>(Lifetime.Singleton).As<ITaskScheduler>();
        builder.Register<TimeService>(Lifetime.Singleton).As<ITimeService>();
        
        // âœ… ä¸šåŠ¡æœåŠ¡
        builder.Register<ShopService>(Lifetime.Singleton).As<IShopService>();
        
        LogManager.Info(LogCategory.System, "[Bootstrapper] æ‰€æœ‰æœåŠ¡å·²æ³¨å†Œ");
    }

    public static T Resolve<T>()
    {
        var bootstrapper = GetCachedBootstrapper();
        if (bootstrapper?.Container != null)
        {
            return bootstrapper.Container.Resolve<T>();
        }
        LogManager.Error(LogCategory.System, $"[Bootstrapper] æ— æ³•è§£æ {typeof(T).Name}");
        return default;
    }
}
```

### ç¬¬äºŒæ­¥ï¼šä½¿ç”¨å·¥å‚åˆ›å»º UIï¼ˆShopUIFactoryï¼‰

```csharp
public class ShopUIFactory : MonoBehaviour
{
    /// <summary>
    /// æ–¹æ¡ˆ 1ï¼šæœ€ç®€å• - ç›´æ¥ä½¿ç”¨ Bootstrapper.Resolve
    /// </summary>
    public UIShopPanelDI CreateShopPanelSimple()
    {
        // è·å–ä¾èµ–
        var shopService = Bootstrapper.Resolve<IShopService>();
        var eventBus = Bootstrapper.Resolve<IEventBus>();
        
        if (shopService == null || eventBus == null)
        {
            LogManager.Error(LogCategory.UI, "[ShopUIFactory] æœåŠ¡è§£æå¤±è´¥");
            return null;
        }

        // åˆ›å»º UI GameObject
        var panelGo = new GameObject("ShopPanel");
        var panel = panelGo.AddComponent<UIShopPanelDI>();
        
        // æ³¨å…¥ä¾èµ–
        panel.Initialize(shopService, eventBus);
        
        LogManager.Info(LogCategory.UI, "[ShopUIFactory] ShopPanel åˆ›å»ºæˆåŠŸ");
        return panel;
    }

    /// <summary>
    /// æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ IObjectResolver å·¥å‚
    /// âœ… VContainer å®˜æ–¹æ¨èæ–¹å¼
    /// </summary>
    public UIShopPanelDI CreateShopPanelWithResolver()
    {
        // è·å–å¯¹è±¡è§£æå™¨
        var resolver = Bootstrapper.Resolve<IObjectResolver>();
        if (resolver == null)
        {
            LogManager.Error(LogCategory.UI, "[ShopUIFactory] æ— æ³•è·å– IObjectResolver");
            return null;
        }

        // åˆ›å»º GameObject
        var panelGo = new GameObject("ShopPanel");
        
        // ä½¿ç”¨ resolver åˆ›å»ºç»„ä»¶å¹¶è‡ªåŠ¨æ³¨å…¥
        var panel = resolver.Instantiate<UIShopPanelDI>(panelGo);
        
        LogManager.Info(LogCategory.UI, "[ShopUIFactory] ShopPanel åˆ›å»ºæˆåŠŸï¼ˆä½¿ç”¨ Resolverï¼‰");
        return panel;
    }

    /// <summary>
    /// æ–¹æ¡ˆ 3ï¼šä»é¢„åˆ¶ä½“åˆ›å»º
    /// </summary>
    public UIShopPanelDI CreateShopPanelFromPrefab()
    {
        var shopService = Bootstrapper.Resolve<IShopService>();
        var eventBus = Bootstrapper.Resolve<IEventBus>();
        
        if (shopService == null || eventBus == null)
        {
            LogManager.Error(LogCategory.UI, "[ShopUIFactory] æœåŠ¡è§£æå¤±è´¥");
            return null;
        }

        // åŠ è½½é¢„åˆ¶ä½“
        var prefab = Resources.Load<UIShopPanelDI>("Prefabs/UIShopPanel");
        if (prefab == null)
        {
            LogManager.Error(LogCategory.UI, "[ShopUIFactory] é¢„åˆ¶ä½“åŠ è½½å¤±è´¥");
            return null;
        }

        // å®ä¾‹åŒ–
        var panel = Instantiate(prefab);
        panel.Initialize(shopService, eventBus);
        
        LogManager.Info(LogCategory.UI, "[ShopUIFactory] ShopPanel ä»é¢„åˆ¶ä½“åˆ›å»ºæˆåŠŸ");
        return panel;
    }
}
```

### ç¬¬ä¸‰æ­¥ï¼šUI ç»„ä»¶æ¥æ”¶ä¾èµ–ï¼ˆUIShopPanelDIï¼‰

```csharp
public class UIShopPanelDI : MonoBehaviour
{
    [SerializeField] private TextMeshProUGUI goldText;
    [SerializeField] private Button purchaseButton;

    private IShopService _shop;
    private IEventBus _eventBus;
    private CompositeDisposable _disposables = new();

    /// <summary>
    /// å·¥å‚æ¨¡å¼ï¼šé€šè¿‡ Initialize æ³¨å…¥ä¾èµ–
    /// </summary>
    public void Initialize(IShopService shop, IEventBus eventBus)
    {
        _shop = shop ?? throw new ArgumentNullException(nameof(shop));
        _eventBus = eventBus ?? throw new ArgumentNullException(nameof(eventBus));
        Debug.Log("[UIShopPanelDI] ä¾èµ–å·²æ³¨å…¥");
    }

    private void Start()
    {
        // æ£€æŸ¥æ˜¯å¦å·²é€šè¿‡ Initialize æ³¨å…¥
        if (_shop != null && _eventBus != null)
        {
            Debug.Log("[UIShopPanelDI] ä¾èµ–å·²å‡†å¤‡ï¼Œå¼€å§‹åˆå§‹åŒ–");
            SubscribeToEvents();
            return;
        }

        // å¤‡é€‰æ–¹æ¡ˆï¼šä» Bootstrapper è·å–
        if (_shop == null)
        {
            _shop = Bootstrapper.Resolve<IShopService>();
        }
        if (_eventBus == null)
        {
            _eventBus = Bootstrapper.Resolve<IEventBus>();
        }

        // éªŒè¯
        if (_shop == null)
        {
            Debug.LogError("[UIShopPanelDI] æ— æ³•è§£æ IShopServiceï¼Œè¯·æ£€æŸ¥ Bootstrapper é…ç½®");
            return;
        }

        SubscribeToEvents();
        Debug.Log("[UIShopPanelDI] åˆå§‹åŒ–å®Œæˆ");
    }

    private void SubscribeToEvents()
    {
        _shop.OnGoldChanged
            .Subscribe(gold => UpdateGoldUI(gold))
            .AddTo(_disposables);

        if (purchaseButton != null)
        {
            purchaseButton.OnClickAsObservable()
                .Subscribe(_ => OnPurchaseButtonClicked())
                .AddTo(_disposables);
        }
    }

    private void UpdateGoldUI(int gold)
    {
        if (goldText != null)
        {
            goldText.text = $"é‡‘å¸: {gold}";
        }
    }

    public async void OnPurchaseButtonClicked()
    {
        bool success = await _shop.PurchaseItem("sword", 1);
        Debug.Log(success ? "âœ“ è´­ä¹°æˆåŠŸ" : "âœ— è´­ä¹°å¤±è´¥");
    }

    private void OnDestroy()
    {
        _disposables?.Dispose();
    }
}
```

---

## ğŸ¯ ä¸‰ç§ä½¿ç”¨æ–¹å¼å¯¹æ¯”

| æ–¹å¼ | æ³¨å†Œ | åˆ›å»º | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|------|------|
| **Bootstrapper.Resolve** | âœ… æ‰‹åŠ¨ | âœ… æ‰‹åŠ¨ | ç®€å•ç›´æ¥ | Service Locator æ¨¡å¼ |
| **å·¥å‚ + Initialize** | âœ… æ‰‹åŠ¨ | âœ… å·¥å‚ | çµæ´»ï¼Œæ˜“äºæµ‹è¯• | éœ€è¦ Initialize æ–¹æ³• |
| **IObjectResolver** | âœ… æ‰‹åŠ¨ | âœ… Resolver | VContainer å®˜æ–¹æ–¹å¼ | éœ€è¦ç†è§£ Resolver |

---

## ğŸ“ å®Œæ•´çš„åœºæ™¯é…ç½®æ­¥éª¤

### 1. å‡†å¤‡ Bootstrapper

- åˆ›å»ºä¸€ä¸ª GameObject åä¸º "Bootstrapper"
- æ·»åŠ  Bootstrapper è„šæœ¬
- ç¡®ä¿ `autoRun` å·²å‹¾é€‰
- æ£€æŸ¥ Inspector ä¸­æ³¨å†Œå™¨åˆ—è¡¨å·²é…ç½®

### 2. åœ¨ Bootstrapper ä»£ç ä¸­æ³¨å†ŒæœåŠ¡

```csharp
private void RegisterFrameworkServices(IContainerBuilder builder)
{
    builder.Register<EventBus>(Lifetime.Singleton).As<IEventBus>();
    builder.Register<TaskScheduler>(Lifetime.Singleton).As<ITaskScheduler>();
    builder.Register<TimeService>(Lifetime.Singleton).As<ITimeService>();
    
    // âœ… æ·»åŠ è¿™ä¸€è¡Œ
    builder.Register<ShopService>(Lifetime.Singleton).As<IShopService>();
}
```

### 3. åˆ›å»ºå•†åº— UI

åœ¨åœºæ™¯ä¸­æ·»åŠ ä¸€ä¸ª GameObjectï¼š
```csharp
public class ShopUIInitializer : MonoBehaviour
{
    private void Start()
    {
        var factory = new ShopUIFactory();
        var panel = factory.CreateShopPanelSimple();
        
        if (panel != null)
        {
            Debug.Log("ShopPanel åˆ›å»ºæˆåŠŸ");
        }
    }
}
```

æˆ–è€…ç›´æ¥åœ¨åœºæ™¯ä¸­æ·»åŠ  UIShopPanelDI ç»„ä»¶ï¼Œå®ƒä¼šè‡ªåŠ¨ä» Bootstrapper è·å–ä¾èµ–ã€‚

---

## âš ï¸ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1ï¼š`æ— æ³•è§£æ IShopService`

**æ£€æŸ¥æ¸…å•**ï¼š
- [ ] Bootstrapper åœ¨åœºæ™¯ä¸­
- [ ] Bootstrapper çš„ `autoRun` å·²å‹¾é€‰
- [ ] åœ¨ `RegisterFrameworkServices` ä¸­æ·»åŠ äº† `builder.Register<ShopService>().As<IShopService>()`
- [ ] æ²¡æœ‰æ‹¼å†™é”™è¯¯

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```csharp
// âœ… æ­£ç¡®
builder.Register<ShopService>(Lifetime.Singleton).As<IShopService>();

// âŒ é”™è¯¯
builder.Register<ShopService>();  // ç¼ºå°‘ .As<IShopService>()
```

### é—®é¢˜ 2ï¼š`NullReferenceException` åœ¨ Start ä¸­

**åŸå› **ï¼šä¾èµ–ä¸º null

**ä¿®å¤**ï¼š
```csharp
private void Start()
{
    // âœ… æ·»åŠ  null æ£€æŸ¥
    if (_shop == null)
    {
        _shop = Bootstrapper.Resolve<IShopService>();
    }
    
    // âœ… éªŒè¯æˆåŠŸ
    if (_shop == null)
    {
        Debug.LogError("IShopService ä¸º null");
        return;
    }
    
    // ç»§ç»­åˆå§‹åŒ–
}
```

### é—®é¢˜ 3ï¼šé‡å¤åˆ›å»ºå®ä¾‹

**åŸå› **ï¼šLifetime è®¾ç½®é”™è¯¯

**ä¿®å¤**ï¼š
```csharp
// âœ… å•ä¾‹ï¼ˆæ¨èï¼‰
builder.Register<ShopService>(Lifetime.Singleton).As<IShopService>();

// âŒ æ¯æ¬¡åˆ›å»ºæ–°å®ä¾‹
builder.Register<ShopService>(Lifetime.Transient).As<IShopService>();
```

---

## ğŸš€ æœ€ä½³å®è·µæ€»ç»“

### DOï¼ˆåº”è¯¥åšï¼‰

âœ… åœ¨ Bootstrapper ä¸­ç»Ÿä¸€æ³¨å†Œæ‰€æœ‰æœåŠ¡  
âœ… ä¸ºä¸åŒçš„æœåŠ¡ä½¿ç”¨åˆé€‚çš„ç”Ÿå‘½å‘¨æœŸ  
âœ… é€šè¿‡ Initialize æ–¹æ³•æˆ– Bootstrapper.Resolve è·å–ä¾èµ–  
âœ… æ·»åŠ  null æ£€æŸ¥é˜²æ­¢å¼‚å¸¸  
âœ… ä½¿ç”¨æ—¥å¿—è®°å½•åˆå§‹åŒ–è¿‡ç¨‹  

### DON'Tï¼ˆä¸åº”è¯¥åšï¼‰

âŒ åœ¨ MonoBehaviour çš„æ„é€ å‡½æ•°ä¸­è¿›è¡Œä¾èµ–æ³¨å…¥  
âŒ ä½¿ç”¨ç¡¬ç¼–ç çš„å•ä¾‹ï¼ˆ`Service.Instance`ï¼‰  
âŒ åœ¨æ²¡æœ‰æ£€æŸ¥å®¹å™¨çš„æƒ…å†µä¸‹è°ƒç”¨ Resolve  
âŒ åˆ›å»ºè¿‡å¤šçš„å·¥å‚ç±»  
âŒ æ³¨å†ŒåŒä¸€ä¸ªæ¥å£å¤šæ¬¡ï¼ˆæœ€åä¸€ä¸ªä¼šè¦†ç›–ï¼‰  

---

## æ€»ç»“

å·¥å‚æ–¹å¼ä¾èµ–æ³¨å…¥çš„æ ¸å¿ƒæµç¨‹ï¼š

```
1. Bootstrapper.Configure()
   â†“
2. RegisterFrameworkServices()
   â†“
3. builder.Register<ShopService>().As<IShopService>()  â† âœ… å…³é”®æ­¥éª¤
   â†“
4. Bootstrapper.Resolve<IShopService>()  â† è·å–å®ä¾‹
   â†“
5. factory.CreatePanel() æˆ– UIShopPanelDI.Initialize()  â† æ³¨å…¥ä¾èµ–
   â†“
6. UI æ­£å¸¸è¿ä½œ
```

ç°åœ¨æ‚¨åº”è¯¥èƒ½å¤ŸæˆåŠŸåˆ›å»ºå’Œæ³¨å…¥ä¾èµ–äº†ï¼
